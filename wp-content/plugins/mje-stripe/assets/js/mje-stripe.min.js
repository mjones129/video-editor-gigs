!function(t,e,o){o.StripeCheckoutModal=o.Modal_Box.extend({el:"#stripe_checkout_modal",events:{"submit #payment-form":"submitPayment"},initialize:function(t){o.Modal_Box.prototype.initialize.apply(this,arguments),this.options=_.extend(this,t),this.isPostJob=this.options.isPostJob,void 0!==this.options.checkoutData&&(this.checkoutData=this.options.checkoutData,this.productData=this.checkoutData.get("p_data")),void 0!==this.options.model&&(this.model=this.options.model),this.blockUi=new o.BlockUi,this.stripe=Stripe(mje_stripe.publishable_key);var e=this.stripe.elements();this.card=e.create("card",{style:{base:{color:"#303238",fontSize:"16px",fontSmoothing:"antialiased","::placeholder":{color:"#ccc"}},invalid:{color:"#e5424d",":focus":{color:"#303238"}}}}),this.card.mount("#card-element");var i=this;this.card.addEventListener("change",function(t){var e=i.$el.find("#card-errors");t.error?e.text(t.error.message):e.text("")})},submitPayment:function(e){e.preventDefault(),$form=t(e.currentTarget);var o=this;o.blockUi.block($form.find(".submit-payment")),this.createToken().catch(function(e){e?o.processPayment(t("#stripeToken").val()):o.blockUi.unblock()})},createToken:function(){var t=this;return this.stripe.createToken(this.card).then(function(e){throw e.error?(t.$el.find("#card-errors").text(e.error.message),!1):(t.stripeTokenHandler(e.token),!0)})},stripeTokenHandler:function(t){this.$el.find("#payment-form").append('<input type="hidden" name="stripeToken" id="stripeToken" value="'+t.id+'"/>')},processPayment:function(e){var o=this;if(o.isPostJob){var i={action:"et-setup-payment",ID:o.model.id,author:o.model.get("post_author"),packageID:o.model.get("et_payment_package"),packageType:o.model.get("et_package_type"),paymentType:"stripe",token:e,package_price_plan:this.model.get("et_package_price_plan")};t.ajax({type:"post",url:ae_globals.ajaxURL,dataType:"json",data:i,beforeSend:function(){},success:function(t,e,i){t.success?(AE.pubsub.trigger("ae:notification",{msg:t.data.msg,notice_type:"success"}),setTimeout(function(){window.location.href=t.data.url,o.blockUi.unblock()},2e3)):AE.pubsub.trigger("ae:notification",{msg:t.data.msg,notice_type:"error"}),o.blockUi.unblock()}})}else o.checkoutData.set("p_payment","stripe"),o.productData.payment_type="stripe",o.checkoutData.set("token",e),o.checkoutData.save("","",{beforeSend:function(){},success:function(t,e,i){e.success?(AE.pubsub.trigger("ae:notification",{notice_type:"success",msg:e.data.msg}),setTimeout(function(){window.location.href=e.data.url,o.blockUi.unblock()},2e3)):(AE.pubsub.trigger("ae:notification",{notice_type:"error",msg:e.msg}),o.blockUi.unblock())}})}}),o.ListPayment=Backbone.View.extend({el:".list-payment-gateway",events:{"click #stripe-gateway":"openStripeModal"},initialize:function(){AE.pubsub.on("mje:after:setup:checkout",this.afterSetupCheckout,this)},openStripeModal:function(){"1"===mje_stripe.is_has_api_key&&(void 0===this.stripeModal&&(this.stripeModal=new o.StripeCheckoutModal({checkoutData:this.checkoutData})),this.stripeModal.openModal())},afterSetupCheckout:function(t){this.checkoutData=t}}),o.postJob=Backbone.View.extend({el:".post-job",events:{"click #stripe-gateway":"openStripeModal"},initialize:function(){this.model={},AE.pubsub.on("ae:submitPostSuccess",this.setupData,this)},setupData:function(t,e){this.model=t},openStripeModal:function(){"1"===mje_stripe.is_has_api_key&&(void 0===this.stripeModal&&(this.stripeModal=new o.StripeCheckoutModal({model:this.model,isPostJob:1})),this.stripeModal.openModal())}}),t(document).ready(function(){new o.ListPayment,mje_stripe.is_postMjob&&new o.postJob;var e="#exp_year, #exp_month, #cvc";t(e).bind("click focus",function(e){e.stopPropagation(),t(this).parent(".form-label").addClass("active")}),t(e).bind("focusout",function(e){e.stopPropagation(),t(this).parent(".form-label").removeClass("active")}),t(window).on("click",function(){t(".card-expiration").removeClass("active")})})}(jQuery,AE.Models,AE.Views);